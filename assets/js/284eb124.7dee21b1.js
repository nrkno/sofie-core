"use strict";(self.webpackChunksofie_documentation=self.webpackChunksofie_documentation||[]).push([[7133],{18202:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var r=n(62540),s=n(43023);const o={title:"MOS-plugins"},i="iFrames MOS-plugins",a={id:"for-developers/mos-plugins",title:"MOS-plugins",description:"The usage of MOS-plugins allow micro frontends to be injected into Sofie for the purpuse of adding content to the production without turning away from the Sofie UI.",source:"@site/docs/for-developers/mos-plugins.md",sourceDirName:"for-developers",slug:"/for-developers/mos-plugins",permalink:"/sofie-core/docs/for-developers/mos-plugins",draft:!1,unlisted:!1,editUrl:"https://github.com/nrkno/sofie-core/edit/master/packages/documentation/docs/for-developers/mos-plugins.md",tags:[],version:"current",frontMatter:{title:"MOS-plugins"},sidebar:"forDevelopers",previous:{title:"Publications",permalink:"/sofie-core/docs/for-developers/publications"}},d={},l=[{value:"Bucket items workflow",id:"bucket-items-workflow",level:2},{value:"Cross-origin drag-and-drop",id:"cross-origin-drag-and-drop",level:2},{value:"The problem",id:"the-problem",level:3},{value:"The &quot;proxy idea&quot;",id:"the-proxy-idea",level:4},{value:"The solution",id:"the-solution",level:3},{value:"Sequence diagram",id:"sequence-diagram",level:3},{value:"Post-messages from the Plugin (drag-side)",id:"post-messages-from-the-plugin-drag-side",level:4},{value:"Post-messages from the Plugin Drop-page",id:"post-messages-from-the-plugin-drop-page",level:4},{value:"Minimal example sequence - happy path",id:"minimal-example-sequence---happy-path",level:4}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"iframes-mos-plugins",children:"iFrames MOS-plugins"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"The usage of MOS-plugins allow micro frontends to be injected into Sofie for the purpuse of adding content to the production without turning away from the Sofie UI."})}),"\n",(0,r.jsx)(t.p,{children:"Example use cases can be browsing and playing clips straight from a video server, or the creation of lower third graphics without storing it in the NRCS."}),"\n",(0,r.jsxs)(t.admonition,{title:"MOS reference",type:"note",children:[(0,r.jsx)(t.p,{children:(0,r.jsx)(t.a,{href:"https://mosprotocol.com/wp-content/MOS-Protocol-Documents/MOSProtocolVersion40/index.html#calibre_link-61",children:"5.3 MOS Plug-in Communication messages"})}),(0,r.jsx)(t.p,{children:"The link points at MOS documentations for MOS 4 (for the benefit of having the best documentation), but will be compatible with most older versions too."})]}),"\n",(0,r.jsx)(t.h2,{id:"bucket-items-workflow",children:"Bucket items workflow"}),"\n",(0,r.jsxs)(t.p,{children:["MOS-plugins are managed through the Shelf-system. They are added as ",(0,r.jsx)(t.code,{children:"external_frame"})," either as a Tab to a Rundown layout or as a Panel to a Dashboard layout."]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.img,{alt:"Video browser MOS Plugin in Shelf tab",src:n(85493).A+"",width:"5110",height:"1750"}),"\nA video server browser plugin shown as a tab in the rundown layout shelf."]}),"\n",(0,r.jsxs)(t.p,{children:["The user can create one or more Buckets. From the plugin they can drag-and-drop content into the buckets. The user can manage the buckets and their content by creating, renaming, re-arranging and deleting. More details available at the ",(0,r.jsx)(t.a,{href:"/docs/user-guide/concepts-and-architecture#buckets",children:"Bucket concept description."})]}),"\n",(0,r.jsx)(t.h2,{id:"cross-origin-drag-and-drop",children:"Cross-origin drag-and-drop"}),"\n",(0,r.jsx)(t.admonition,{title:"Bucket workflow without drag-and-drop",type:"note",children:(0,r.jsxs)(t.p,{children:["The plugin iFrame can send a ",(0,r.jsx)(t.code,{children:"postMessage"})," call with an ",(0,r.jsx)(t.code,{children:"ncsItem"})," payload to programatically create an ncsItem without the drag-and-drop interaction. This is a viable solution which avoids cross-origin drag-and-drop problems."]})}),"\n",(0,r.jsx)(t.h3,{id:"the-problem",children:"The problem"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Web browsers prevent drops into a webpage if the drag started from a page hosted on another origin."})}),"\n",(0,r.jsx)(t.p,{children:"This means that drag-and-drop must happen between pages from the same origin. This is relevant for MOS-plugins, as they are supposed to be displayed in iFrames. Specifically, this means that the plugin in the iFrame must be served from the same origin as the parent page (where the drop will happen)."}),"\n",(0,r.jsx)(t.p,{children:"There are no properties or options to bypass this from within HTML/Javascript. Bypassing is theoretically possible by overriding the browser's security settings, but this is not recommended."}),"\n",(0,r.jsx)(t.admonition,{title:"Background",type:"note",children:(0,r.jsxs)(t.p,{children:["The background for the policy is discussed in this Chromium Issue from 2010: ",(0,r.jsx)(t.a,{href:"https://issues.chromium.org/issues/40083787",children:"Security: do not allow on-page drag-and-drop from non-same-origin frames (or require an extra gesture)"})]})}),"\n",(0,r.jsx)(t.admonition,{title:"What counts as different origins?",type:"note",children:(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Sofie Server Domain"}),(0,r.jsx)(t.th,{children:"Plugin Domain"}),(0,r.jsx)(t.th,{children:"Cross-origin or Same-origin?"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://mySofie.com:443"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://myPlugin.com:443"})}),(0,r.jsx)(t.td,{children:"cross-origin: different domains"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://www.mySofie.com:443"})}),(0,r.jsx)(t.td,{children:"cross-origin: different subdomains"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://myPlugin.mySofie.com:443"})}),(0,r.jsx)(t.td,{children:"\xa0cross-origin: different subdomains"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"http://mySofie.com:443"})}),(0,r.jsx)(t.td,{children:"\xa0cross-origin: different schemes"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://mySofie.com:80"})}),(0,r.jsx)(t.td,{children:"\xa0cross-origin: different ports"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://mySofie.com:443/myPlugin"})}),(0,r.jsx)(t.td,{children:"same-origin: domain, scheme and port match"})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"https://mySofie.com/myPlugin"})}),(0,r.jsx)(t.td,{children:"same-origin: domain, scheme and port match (https implies port 443)"})]})]})]})}),"\n",(0,r.jsx)(t.h4,{id:"the-proxy-idea",children:'The "proxy idea"'}),"\n",(0,r.jsx)(t.p,{children:"As you can tell from the table, you need to exactly match both the protocol, domain and port number. More importantly, different subdomains trigger the cross-origin policy."}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.em,{children:"The proxy idea"})," is to use rewrite-rules in a proxy server (e.g. NGINX) to serve the plugin from a path on the Sofie server's domain. As this can't be done as subdomains, that leaves the option of having a folder underneath the top level of the Sofie server's domain."]}),"\n",(0,r.jsxs)(t.p,{children:["An example of this would be to serve Sofie at ",(0,r.jsx)(t.code,{children:"https://mysofie.com"})," and then host the plugin (directly or via a proxy) at ",(0,r.jsx)(t.code,{children:"https://mysofie.com/myplugin"}),". Technically this will work, but this solution is fragile. All links within the plugin will have to be either absolute or truly relative links that take the URL structure into account. This is doable if the plugin is being developed with this in mind. But it leads to a fragile tight coupling between the plugin and the host application (Sofie) which can break with any inconsiderate udate in the future."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Example of linking from a (potentially proxied) subfolder",type:"note",children:[(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Case:"})," ",(0,r.jsx)(t.code,{children:"https://mysofie.com/myplugin/index.html"})," wants to acccess ",(0,r.jsx)(t.code,{children:"https://mysofie.com/myplugin/static/images/logo.png"}),"."]}),(0,r.jsxs)(t.p,{children:["Normally the plugin would be developed and bundled to work standalone, resulting in a link relative to its own base path, giving ",(0,r.jsx)(t.code,{children:"/static/images/logo.png"})," which here wrongly resolves to ",(0,r.jsx)(t.code,{children:"https://mysofie.com/static/images/logo.png"}),"."]}),(0,r.jsxs)(t.p,{children:["The plugin would need to use either use the absolute ",(0,r.jsx)(t.code,{children:"https://mysofie.com/myplugin/static/images/logo.png"})," or the relative ",(0,r.jsx)(t.code,{children:"images/static/logo.png"})," or ",(0,r.jsx)(t.code,{children:"./images/static/logo.png"})," or even ",(0,r.jsx)(t.code,{children:"/myplugin/static/images/logo.png"})," to point to the right resource."]})]}),"\n",(0,r.jsx)(t.h3,{id:"the-solution",children:"The solution"}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Sofie proposes a drag-and-drop/postMessage hybrid interface."}),"\nIn this model the user interactions of drag-and-drop are targeting a dedicated Drop page served by the plugin-server (same-origin to the plugin). This can be transparently overlaid the real drop region and intercept drop events. The Bucket system has built-in support for this, configured as an additional property to the External frame panel setup in Shelf config."]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Configuration of External frame with dedicated drop-page",src:n(63992).A+"",width:"1494",height:"1344"})}),"\n",(0,r.jsx)(t.p,{children:"The true communication channel between the plugin and Sofie becomes a postMessage protocol where the plugin is managing all drag-and-drop events and converts them into the postMessage protocol. Sofie also handles edge cases such as timeouts, drag leaving the browser etc."}),"\n",(0,r.jsx)(t.h3,{id:"sequence-diagram",children:"Sequence diagram"}),"\n",(0,r.jsx)(t.h4,{id:"post-messages-from-the-plugin-drag-side",children:"Post-messages from the Plugin (drag-side)"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Message"}),(0,r.jsx)(t.th,{children:"Payload"}),(0,r.jsx)(t.th,{children:"Description"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"dragStart"}),(0,r.jsx)(t.td,{children:"-"}),(0,r.jsxs)(t.td,{children:["Re-sends the DOM event dragStart as a postMessage of the same kind. ",(0,r.jsx)("br",{})," This is the signal to Sofie to toggle on the Drop-zone and indicate in the UI that a drag is happening."]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"dragEnd"}),(0,r.jsx)(t.td,{children:"-"}),(0,r.jsxs)(t.td,{children:["Re-sends the DOM event dragEnd as a postMessage of the same kind. ",(0,r.jsx)("br",{})," This is the signal to Sofie to toggle off the Drop-zone and reset the UI."]})]})]})]}),"\n",(0,r.jsx)(t.h4,{id:"post-messages-from-the-plugin-drop-page",children:"Post-messages from the Plugin Drop-page"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:"Message"}),(0,r.jsx)(t.th,{children:"Payload"}),(0,r.jsx)(t.th,{children:"Description"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"dragEnter"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"{event: 'dragEnter', label: string}"})}),(0,r.jsxs)(t.td,{children:["To set the UI to reflect an object is being dragged into a specific bucket. ",(0,r.jsx)("br",{})," The label property can be used for showing a simple placeholder in the bucket."]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"dragLeave"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"{event: 'dragLeave'}"})}),(0,r.jsx)(t.td,{children:"To reset any UI."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"drop"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"{event: 'drop'}"})}),(0,r.jsx)(t.td,{children:"To synchronously react to the drop in the UI."})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"data"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"{event: 'data', data: ncsItem}"})}),(0,r.jsxs)(t.td,{children:["To (a)synchronously receive the payload. ",(0,r.jsx)("br",{})," The expected format is an ",(0,r.jsx)(t.code,{children:"ncsItem"})," MOS message (XML string)"]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:"error"}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"{event: 'error', message}"})}),(0,r.jsx)(t.td,{children:"To cancel the drag-operation and handle any errors."})]})]})]}),"\n",(0,r.jsx)(t.admonition,{title:"Please note",type:"note",children:(0,r.jsx)(t.p,{children:"Please note how all interactions are happening over the postMessage interface.\nNo DOM-driven drag-n-drop events are relevant for Sofie, as they are solely handled between the plugin and its drop-page."})}),"\n",(0,r.jsx)(t.mermaid,{value:"sequenceDiagram\nautonumber\n\nactor user as User\n\nparticipant plugin as Plugin<br/>Frontend\nparticipant shelf as Sofie Shelf Component\nparticipant bucket as Sofie Bucket Component\nparticipant drop as Plugin<br/>Drop-page\n\nuser->>plugin: Starts dragging from Plugin\nplugin->>shelf: postMessage dragStartEvent\nshelf--)shelf: 10 000ms timeout to trigger a dragEndEvent <br />if the drag doesn't cancel or successfully drop before that.\nshelf->>shelf: Filter for valid Drop Zones <br />based on the optional properties of the dragStartEvent\nshelf->>bucket: Sofie React event dragStartEvent\nbucket->>drop: Shows iFrame Drop Zone\n\n\n\nuser->>drop: Drags into the area of a Drop Zone (DOM dragEnter event)\nnote right of drop: Read payload to provide a title <br />in the dragEnterEvent\ndrop->>drop: e.dataTransfer.getData('text/plain');\ndrop->>bucket: postmessage object dragEnterEvent\n\nloop dragOver events\n    user-)drop: Drag moves over drop target (DOM dragover event)\n    drop->>drop: (re)set timeout 100ms<br />to trigger faux dragLeave\nend\n\ndrop--)drop: dragLeave timeout expires\ndrop->>bucket: postmessage object dragEnterEvent (faux)\n\n\nuser->>drop: Drags out of a Drop Zone, or dragOver timeout (DOM dragLeave event)\ndrop->>drop: cancel dragOver timeout\ndrop->>bucket: postmessage object dragLeaveEvent\n\n\n\nNote over user,drop: Unknown order of events. Handle both outcomes of the race.\npar Successful drop or Cancelled drag\n        user->>plugin: Successful drop <br /> or Cancel drag on ESC <br /> or drop outside of Drop region <br /> (DOM dragEnd event)\n        plugin->>shelf: postMessage dragEndEvent\n        shelf->>shelf: Clear the drop-/cancel-timeout.\n        shelf->>bucket: Sofie React event dragEndEvent\n        bucket->>drop: Hides iFrame Drop Zone\nand Drops in bucket\n    user->>drop: Drop (DOM drop event)\n    drop->>bucket: dropEvent\n    bucket--)bucket: Set timeout to trigger an user-facing error <br />if the data doesn't return in time.\n    bucket->>bucket: Set loader UI\n\n    drop->>drop: e.dataTransfer.getData('text/plain');\n\n\n    alt Success\n        drop--)bucket: postmessage object dataEvent\n        bucket->>bucket: Clear loader UI/Set success UI\n    else Error\n        drop--)bucket: postmessage object errorEvent\n        bucket->>bucket: Clear loader UI\n        bucket--)user: Error message\n    else Timeout\n        bucket->>bucket: Clear loader UI\n        bucket--)user: Error message\n    end\nend\n"}),"\n",(0,r.jsx)(t.h4,{id:"minimal-example-sequence---happy-path",children:"Minimal example sequence - happy path"}),"\n",(0,r.jsx)(t.p,{children:"Don't worry, the sequence diagram shows a lot more detail than you need to think about. Consider this simple happy-path sequence as a representative interaction between the 3 actors (Plugin, Drop-page and Sofie):"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Plugin ",(0,r.jsx)(t.code,{children:"dragStart"})]}),"\n",(0,r.jsxs)(t.li,{children:["Drop-page ",(0,r.jsx)(t.code,{children:"dragEnter"})]}),"\n",(0,r.jsxs)(t.li,{children:["Plugin ",(0,r.jsx)(t.code,{children:"dragEnd"})," and Drop-page ",(0,r.jsx)(t.code,{children:"drop"})]}),"\n",(0,r.jsxs)(t.li,{children:["Drop-page ",(0,r.jsx)(t.code,{children:"data"})]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},85493:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/shelf-bucket-items-eafd112bd0a53684c419a16a29114522.jpg"},63992:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/shelf-external_frame-config-bb2905abda2f31f1ed2b3a0f6a6c8e13.png"},43023:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(63696);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);