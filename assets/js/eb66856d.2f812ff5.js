"use strict";(self.webpackChunksofie_documentation=self.webpackChunksofie_documentation||[]).push([[3747],{5318:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var o=a(7378);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),c=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(a),u=n,m=d["".concat(l,".").concat(u)]||d[u]||h[u]||r;return a?o.createElement(m,i(i({ref:t},p),{},{components:a})):o.createElement(m,i({ref:t},p))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:n,i[1]=s;for(var c=2;c<r;c++)i[c]=a[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,a)}u.displayName="MDXCreateElement"},8297:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var o=a(5773),n=(a(7378),a(5318));const r={title:"Data Model",sidebar_position:9},i=void 0,s={unversionedId:"for-developers/data-model",id:"for-developers/data-model",title:"Data Model",description:"Sofie persists the majority of its data in a MongoDB database. This allows us to use Typescript friendly documents,",source:"@site/docs/for-developers/data-model.md",sourceDirName:"for-developers",slug:"/for-developers/data-model",permalink:"/sofie-core/docs/for-developers/data-model",draft:!1,editUrl:"https://github.com/nrkno/sofie-core/edit/master/packages/documentation/docs/for-developers/data-model.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{title:"Data Model",sidebar_position:9},sidebar:"forDevelopers",previous:{title:"JSON Config Schema",permalink:"/sofie-core/docs/for-developers/json-config-schema"},next:{title:"Worker Threads & Locks",permalink:"/sofie-core/docs/for-developers/worker-threads-and-locks"}},l={},c=[{value:"Collection Ownership",id:"collection-ownership",level:2},{value:"Meteor",id:"meteor",level:3},{value:"Ingest",id:"ingest",level:3},{value:"Playout",id:"playout",level:3},{value:"RundownPlaylist",id:"rundownplaylist",level:4},{value:"Part vs PartInstance and Piece vs PieceInstance",id:"part-vs-partinstance-and-piece-vs-pieceinstance",level:4}],p={toc:c},d="wrapper";function h(e){let{components:t,...a}=e;return(0,n.kt)(d,(0,o.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Sofie persists the majority of its data in a MongoDB database. This allows us to use Typescript friendly documents,\nwithout needing to worry too much about the strictness of schemas, and allows us to watch for changes happening inside\nthe database as a way of ensuring that updates are reactive."),(0,n.kt)("p",null,"Data is typically pushed to the UI or the gateways through ",(0,n.kt)("a",{parentName:"p",href:"./publications"},"Publications")," over the DDP connection that Meteor provides."),(0,n.kt)("h2",{id:"collection-ownership"},"Collection Ownership"),(0,n.kt)("p",null,"Each collection in MongoDB is owned by a different area of Sofie. In some cases, changes are also made by another area, but we try to keep this to a minimum.",(0,n.kt)("br",{parentName:"p"}),"\n","In every case, any layout changes and any scheduled cleanup are performed by the Meteor layer for simplicity."),(0,n.kt)("h3",{id:"meteor"},"Meteor"),(0,n.kt)("p",null,"This category of collections is rather loosely defined, as it ends up being everything that doesn't belong somewhere else"),(0,n.kt)("p",null,"This consists of anything that is configurable from the Sofie UI, anything needed soley for the UI and some other bits. Additionally, there are some collections which are populated by other portions of a Sofie system, such as by package manager, through an API over DDP.",(0,n.kt)("br",{parentName:"p"}),"\n","Currently, there is not a very clearly defined flow for modifying these documents, with the UI often making changes directly with minimal or no validation."),(0,n.kt)("p",null,"This includes:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Blueprint.ts"},"Blueprints")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Buckets.ts"},"Buckets")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/CoreSystem.ts"},"CoreSystem")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Evaluations.ts"},"Evaluations")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ExternalMessageQueue.ts"},"ExternalMessageQueue")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ExpectedPackageWorkStatuses.ts"},"ExpectedPackageWorkStatuses")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/MediaObjects.ts"},"MediaObjects")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/MediaWorkFlows.ts"},"MediaWorkFlows")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/MediaWorkFlowSteps.ts"},"MediaWorkFlowSteps")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Organization.ts"},"Organizations")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PackageInfos.ts"},"PackageInfos")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PackageContainerPackageStatus.ts"},"PackageContainerPackageStatuses")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PackageContainerStatus.ts"},"PackageContainerStatuses")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PeripheralDeviceCommand.ts"},"PeripheralDeviceCommands")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PeripheralDevice.ts"},"PeripheralDevices")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/RundownLayouts.ts"},"RundownLayouts")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ShowStyleBase.ts"},"ShowStyleBase")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ShowStyleVariant.ts"},"ShowStyleVariant")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Snapshots.ts"},"Snapshots")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Studio.ts"},"Studio")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/TriggeredActions.ts"},"TriggeredActions")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/TranslationsBundles.ts"},"TranslationsBundles")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/UserActionsLog.ts"},"UserActionsLog")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Users.ts"},"Users")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/meteor/lib/collections/Workers.ts"},"Workers")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/WorkerThreads.ts"},"WorkerThreads"))),(0,n.kt)("h3",{id:"ingest"},"Ingest"),(0,n.kt)("p",null,"This category of collections is owned by the ingest ",(0,n.kt)("a",{parentName:"p",href:"/sofie-core/docs/for-developers/worker-threads-and-locks"},"worker threads"),", and models a Rundown based on how it is defined by the NRCS."),(0,n.kt)("p",null,"These collections are not exposed as writable in Meteor, and are only allowed to be written to by the ingest worker threads.",(0,n.kt)("br",{parentName:"p"}),"\n","There is an exception to both of these; Meteor is allowed to write to it as part of migrations, and cleaning up old documents. While the playout worker is allowed to modify certain Segments that are labelled as being owned by playout."),(0,n.kt)("p",null,"The collections which are owned by the ingest workers are:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/AdLibActions.ts"},"AdLibActions")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/AdLibPieces.ts"},"AdLibPieces")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/BucketAdLibActions.ts"},"BucketAdLibActions")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/BucketAdLibPieces.ts"},"BucketAdLibPieces")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ExpectedMediaItems.ts"},"ExpectedMediaItems")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ExpectedPackages.ts"},"ExpectedPackages")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/ExpectedPlayoutItems.ts"},"ExpectedPlayoutItems")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/IngestDataCache.ts"},"IngestDataCache")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Parts.ts"},"Parts")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Pieces.ts"},"Pieces")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/RundownBaselineAdLibActions.ts"},"RundownBaselineAdLibActions")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/RundownBaselineAdLibPieces.ts"},"RundownBaselineAdLibPieces")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/RundownBaselineObjects.ts"},"RundownBaselineObjects")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Rundowns.ts"},"Rundowns")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Segments.ts"},"Segments"))),(0,n.kt)("p",null,"These collections model a Rundown from the NRCS in a Sofie form. Almost all of these contain documents which are largely generated by blueprints.",(0,n.kt)("br",{parentName:"p"}),"\n","Some of these collections are used by package manager to initiate work, while others form a view of the Rundown for the users, and are used as part of the model for playout."),(0,n.kt)("h3",{id:"playout"},"Playout"),(0,n.kt)("p",null,"This category of collections is owned by the playout ",(0,n.kt)("a",{parentName:"p",href:"/sofie-core/docs/for-developers/worker-threads-and-locks"},"worker threads"),", and is used to model the playout of a Rundown or set of Rundowns."),(0,n.kt)("p",null,"During the final stage of an ingest operation, there is a period where the ingest worker aquires a ",(0,n.kt)("inlineCode",{parentName:"p"},"PlaylistLock"),", so that it can ensure that the RundownPlaylist the Rundown is a part of is updated with any necessary changes following the ingest operation. During this lock, it will also attempt to ",(0,n.kt)("a",{parentName:"p",href:"./for-blueprint-developers/sync-ingest-changes"},"sync any ingest changes")," to the PartInstances and PieceInstances, if supported by the blueprints."),(0,n.kt)("p",null,"As before, Meteor is allowed to write to these collections as part of migrations, and cleaning up old documents."),(0,n.kt)("p",null,"The collections which can only be modified inside of a ",(0,n.kt)("inlineCode",{parentName:"p"},"PlaylistLock")," are:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PartInstances.ts"},"PartInstances")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/PieceInstances.ts"},"PieceInstances")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/RundownPlaylists.ts"},"RundownPlaylists")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/Timelines.ts"},"Timelines")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/nrkno/sofie-core/blob/master/packages/corelib/src/dataModel/TimelineDatastore.ts"},"TimelineDatastore"))),(0,n.kt)("p",null,"These collections are used in combination with many of the ingest collections, to drive playout."),(0,n.kt)("h4",{id:"rundownplaylist"},"RundownPlaylist"),(0,n.kt)("p",null,"RundownPlaylists are a Sofie invention designed to solve one problem; in some NRCS it is beneficial to build a show across multiple Rundowns, which should then be concatenated for playout.",(0,n.kt)("br",{parentName:"p"}),"\n","In particular, MOS has no concept of a Playlist, only Rundowns, and it was here where we need to be able to combine multiple Rundowns."),(0,n.kt)("p",null,"This functionality can be used to either break down long shows into managable chunks, or to indicate a different type of show between the each portion."),(0,n.kt)("p",null,"Because of this, RundownPlaylists are largely missing from the ingest side of Sofie. We do not expose them in the ingest APIs, or do anything with them throughout the majority of the blueprints generating a Rundown.",(0,n.kt)("br",{parentName:"p"}),"\n","Instead, we let the blueprints specify that a Rundown should be part of a RundownPlaylist by setting the ",(0,n.kt)("inlineCode",{parentName:"p"},"playlistExternalId")," property, where multiple Rundowns in a Studio with the same id will be grouped into a RundownPlaylist.",(0,n.kt)("br",{parentName:"p"}),"\n","If this property is not used, we automatically generate a RundownPlaylist containing the Rundown by itself."),(0,n.kt)("p",null,"It is during the final stages of an ingest operation, where the RundownPlaylist will be generated (with the help of blueprints), if it is necessary.",(0,n.kt)("br",{parentName:"p"}),"\n","Another benefit to this approach, is that it allows for very cheaply and easily moving Rundowns between RundownPlaylists, even safely affecting a RundownPlaylist that is currently on air."),(0,n.kt)("h4",{id:"part-vs-partinstance-and-piece-vs-pieceinstance"},"Part vs PartInstance and Piece vs PieceInstance"),(0,n.kt)("p",null,"In the early days of Sofie, we had only Parts and Pieces, no PartInstances and PieceInstances."),(0,n.kt)("p",null,"This quickly became costly and complicated to handle cases where the user used Adlibs in Sofie. Some of the challenges were:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"When a Part is deleted from the NRCS and that part is on air, we don't want to delete it in Sofie immediately"),(0,n.kt)("li",{parentName:"ul"},"When a Part is modified in the NRCS and that part is on air, we may not want to apply all of the changes to playout immediately"),(0,n.kt)("li",{parentName:"ul"},"When a Part has finished playback and is set-as-next again, we need to make sure to discard any changes made by the previous playout, and restore it to as if was refreshly ingested (including the changes we ignored while it was on air)"),(0,n.kt)("li",{parentName:"ul"},"When creating an adlib part, we need to be sure that an ingest operation doesn't attempt to delete it, until playout is finished with it."),(0,n.kt)("li",{parentName:"ul"},"After using an adlib in a part, we need to remove the piece it created when we set-as-next again, or reset the rundown"),(0,n.kt)("li",{parentName:"ul"},"When an earlier part is removed, where an infinite piece has spanned into the current part, we may not want to remove that infinite piece")),(0,n.kt)("p",null,"Our solution to some of this early on was to not regenerate certain Parts when receiving ingest operations for them, and to defer it until after that Part was off air. While this worked, it was not optimal to re-run ingest operations like that while doing a take. This also required the blueprint api to generate a single part in each call, which we were starting to find limiting. This was also problematic when resetting a rundown, as that would often require rerunning ingest for the whole rundown, making it a notably slow operation."),(0,n.kt)("p",null,"At this point in time, Adlib Actions did not exist in Sofie. They are able to change almost every property of a Part of Piece that ingest is able to define, which makes the resetting process harder."),(0,n.kt)("p",null,"PartInstances and PieceInstances were added as a way for us to make a copy of each Part and Piece, as it was selected for playout, so that we could allow ingest without risking affecting playout, and to simplify the cleanup performed. The PartInstances and PieceInstances are our record of how the Rundown was played, which we can utilise to output metadata such as for chapter markers on a web player. In earlier versions of Sofie this was tracked independently with an ",(0,n.kt)("inlineCode",{parentName:"p"},"AsRunLog"),", which resulted in odd issues such as having ",(0,n.kt)("inlineCode",{parentName:"p"},"AsRunLog")," entries which refered to a Part which no longer existed, or whose content was very different to how it was played."),(0,n.kt)("p",null,"Later on, this separation has allowed us to more cleanly define operations as ingest or playout, and allows us to run them in parallel with more confidence that they won't accidentally wipe out each others changes. Previously, both ingest and playout operations would be modifying documents in the Piece and Part collections, making concurrent operations unsafe as they could be modifying the same Part or Piece."))}h.isMDXComponent=!0}}]);