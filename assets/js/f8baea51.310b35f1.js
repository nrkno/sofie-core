"use strict";(self.webpackChunksofie_documentation=self.webpackChunksofie_documentation||[]).push([[272],{5318:(e,t,o)=>{o.d(t,{Zo:()=>u,kt:()=>m});var i=o(7378);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,i,n=function(e,t){if(null==e)return{};var o,i,n={},a=Object.keys(e);for(i=0;i<a.length;i++)o=a[i],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)o=a[i],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var l=i.createContext({}),c=function(e){var t=i.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):r(r({},t),e)),o},u=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var o=e.components,n=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(o),d=n,m=p["".concat(l,".").concat(d)]||p[d]||h[d]||a;return o?i.createElement(m,r(r({ref:t},u),{},{components:o})):i.createElement(m,r({ref:t},u))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=o.length,r=new Array(a);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:n,r[1]=s;for(var c=2;c<a;c++)r[c]=o[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,o)}d.displayName="MDXCreateElement"},2040:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var i=o(5773),n=(o(7378),o(5318));const a={title:"Publications",sidebar_position:12},r=void 0,s={unversionedId:"for-developers/publications",id:"for-developers/publications",title:"Publications",description:"To ensure that the UI of Sofie is reactive, we are leveraging publications over the DDP connection that Meteor provides.",source:"@site/docs/for-developers/publications.md",sourceDirName:"for-developers",slug:"/for-developers/publications",permalink:"/sofie-core/docs/for-developers/publications",draft:!1,editUrl:"https://github.com/nrkno/sofie-core/edit/master/packages/documentation/docs/for-developers/publications.md",tags:[],version:"current",sidebarPosition:12,frontMatter:{title:"Publications",sidebar_position:12},sidebar:"forDevelopers",previous:{title:"API Stability",permalink:"/sofie-core/docs/for-developers/api-stability"}},l={},c=[{value:"MongoDB Publications",id:"mongodb-publications",level:2},{value:"Custom Publications",id:"custom-publications",level:2},{value:"Live Status Gateway",id:"live-status-gateway",level:2}],u={toc:c},p="wrapper";function h(e){let{components:t,...o}=e;return(0,n.kt)(p,(0,i.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"To ensure that the UI of Sofie is reactive, we are leveraging publications over the DDP connection that Meteor provides.",(0,n.kt)("br",{parentName:"p"}),"\n","In its most basic form, this allows for streaming MongoDB document updates as they happen to the UI, and there is also a structure in place for 'Custom Publications' which appear like a MongoDB collection to the client, but are generated in-memory collections of data allowing us to do some processing of data before publishing it to the client."),(0,n.kt)("p",null,"It is possible to subscribe to these publications outside of Meteor, but we have not found any maintained ddp clients, except for the one we are using in ",(0,n.kt)("inlineCode",{parentName:"p"},"server-core-integration"),". The protocol is simple and stable and has documentation on the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/meteor/meteor/blob/devel/packages/ddp/DDP.md"},"Meteor GitHub"),", and should be easy to implement in another language if desired."),(0,n.kt)("p",null,"All of the publication implementations reside in ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/nrkno/sofie-core/tree/master/meteor/server/publications"},(0,n.kt)("inlineCode",{parentName:"a"},"meteor/server/publications")," folder"),", and are typically pretty well isolated from the rest of the code we have in Meteor."),(0,n.kt)("p",null,"We prefer using publications in Sofie over polling because:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"there are not enough DDP clients to a single Sofie installation for the number of connected clients to be problematic"),(0,n.kt)("li",{parentName:"ul"},"polling can be costly for many of these publications without some form of caching or tracking changes (which starts to get to a similar level of complexity)"),(0,n.kt)("li",{parentName:"ul"},"we can be more confident that all the clients have the same data as the database is our point of truth"),(0,n.kt)("li",{parentName:"ul"},"the system can be more reactive as changes are pushed to interested parties with minimal intervention")),(0,n.kt)("h2",{id:"mongodb-publications"},"MongoDB Publications"),(0,n.kt)("p",null,"A majority of data is sent to the client utilising Meteor's ability to publish a MongoDB cursor. This allows us to run a MongoDB query on the backend, and let it handle the publishing of individual changes."),(0,n.kt)("p",null,"In some (typically older) publications, we let the client specify the MongoDB query to use for the subscription, where we perform some basic validation and authentication before executing the query."),(0,n.kt)("p",null,"In typically newer publications, we are formalising the publications a bit better by requiring some simpler parameters to the publication, with the query then generated on the backend. This will help us ensure that the queries are made with suitable indices, and to ensure that subscriptions are deduplicated where possible."),(0,n.kt)("h2",{id:"custom-publications"},"Custom Publications"),(0,n.kt)("p",null,"There has been a recent push towards using more 'custom' publications for streaming data to the UI. While we are unsure if this will be beneficial for every publication, it is really beneficial for others as it allows us to do some pre-computation of data before sending it to the client."),(0,n.kt)("p",null,"To achieve this, we have an ",(0,n.kt)("inlineCode",{parentName:"p"},"optimisedObserver")," flow which is designed to help maange to a custom publication, with a few methods to fill in to setup the reactivity and the data transformation."),(0,n.kt)("p",null,"One such publication is the ",(0,n.kt)("inlineCode",{parentName:"p"},"PieceContentStatus"),", prior to version 1.50, this was computed inside the UI.",(0,n.kt)("br",{parentName:"p"}),"\n","A brief overview of this publication, is that it looks at each Piece in a Rundown, and reports whether the Piece is 'OK'. This check is primarily focussed on Pieces containing clips, where it will check the metadata generated by either package manager or media manager to ensure that the clip is marked as being ready for playout, and that it has the correct format and some other quality checks."),(0,n.kt)("p",null,"To do this on the client meant needing to subscribe to the whole contents of a couple of MongoDB collections, as it is not easy to determine which documents will be needed until the check is being run. This caused some issues as these collections could get rather large. We also did not always have every Piece loaded in the UI, so had to defer some of the computation to the backend via polling."),(0,n.kt)("p",null,"This makes it more suitable for a custom publication, where we can more easily and cheaply do this computation without being concerned about causing UI lockups and with less concern about memory pressure. Performing very granular MongoDB queries is also cheaper. The result is that we build a graph of what other documents are used for the status of each Piece, so we can cheaply react to changes to any of those documents, while also watching for changes to the pieces."),(0,n.kt)("h2",{id:"live-status-gateway"},"Live Status Gateway"),(0,n.kt)("p",null,"The Live Status Gateway was introduced to Sofie in version 1.50. This gateway serves as a way for an external system to subscribe to publications which are designed to be simpler than the ones we publish over DDP. These publications are intended to be used by external systems which need a 'stable' API and to not have too much knowledge about the inner workings of Sofie. See ",(0,n.kt)("a",{parentName:"p",href:"/sofie-core/docs/for-developers/api-stability"},"Api Stability")," for more details."))}h.isMDXComponent=!0}}]);